<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Action Hero</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* Prevent scrolling */
            touch-action: none; /* Better touch support */
            color: white;
            text-align: center;
        }

        #game-container {
            position: relative;
            max-width: 600px;
            height: 100vh;
            margin: 0 auto;
            background: #333;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Overlays */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(0,0,0,0.85);
            z-index: 10;
        }
        .hidden { display: none !important; }

        h1 { font-size: 40px; margin: 0 0 20px 0; color: #4db6ac; text-shadow: 2px 2px #000; }
        h2 { font-size: 24px; color: #ffca28; }
        p { font-size: 18px; color: #ccc; max-width: 80%; }

        .btn {
            background: #009688;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 22px;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 5px 0 #00695c;
            transition: transform 0.1s;
            width: 250px;
            font-weight: bold;
        }
        .btn:active { transform: translateY(5px); box-shadow: none; }
        .btn-red { background: #e53935; box-shadow: 0 5px 0 #c62828; }
        
        /* HUD during game */
        #hud {
            position: absolute;
            top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            pointer-events: none;
            font-size: 24px; font-weight: bold;
            text-shadow: 1px 1px 2px black;
        }
        
        /* Controls hint */
        .controls-hint {
            position: absolute; bottom: 20px; width: 100%;
            text-align: center; font-size: 14px; color: #888;
            pointer-events: none;
        }

    </style>
</head>
<body>

<div id="game-container">
    
    <!-- MAIN MENU -->
    <div id="menu" class="overlay">
        <h1>Math Action Hero</h1>
        <p>Real games. Real math.</p>
        <button class="btn" onclick="startGame('runner')">ü¶ò Wombat Runner</button>
        <button class="btn" onclick="startGame('astro')">üöÄ Astro Blaster</button>
        <p style="font-size:14px; margin-top:20px">High Scores saved automatically!</p>
    </div>

    <!-- GAME OVER SCREEN -->
    <div id="gameover" class="overlay hidden">
        <h1>GAME OVER</h1>
        <h2>Score: <span id="finalScore">0</span></h2>
        <p id="highScoreMsg"></p>
        <button class="btn" onclick="location.reload()">Menu</button>
        <button class="btn btn-red" onclick="restartGame()">Try Again</button>
    </div>

    <!-- HUD -->
    <div id="hud" class="hidden">
        <div>Score: <span id="scoreDisplay">0</span></div>
        <div id="livesDisplay">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
    </div>

    <canvas id="gameCanvas"></canvas>
    
    <div class="controls-hint" id="controlsHint"></div>
</div>

<script>
/** 
 * MATH ACTION HERO ENGINE
 * Single file game engine by Claude
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let animationId;
let gameMode = null; // 'runner' or 'astro'

// Adjust canvas size
function resize() {
    canvas.width = document.getElementById('game-container').offsetWidth;
    canvas.height = document.getElementById('game-container').offsetHeight;
}
window.addEventListener('resize', resize);
resize();

// Game State
let state = {
    score: 0,
    lives: 3,
    speed: 0,
    isPlaying: false,
    question: null,
    answers: [], // Objects on screen
    player: { x: 0, y: 0, w: 50, h: 50, lane: 1 }, // Lane 0, 1, 2
    lastSpawn: 0
};

// --- AUDIO (Synthesized beeps) ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContext();
function playSound(type) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    if(type === 'correct') {
        osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    } else if (type === 'wrong') {
        osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
    }
}

// --- MATH GENERATOR ---
function getMathQuestion() {
    // Mix of Year 3 skills
    const type = Math.random();
    
    if(type < 0.4) { // Addition
        const a = Math.floor(Math.random()*20)+5;
        const b = Math.floor(Math.random()*20)+5;
        return { q: `${a} + ${b}`, a: a+b };
    } 
    else if (type < 0.7) { // Subtraction
        const a = Math.floor(Math.random()*30)+10;
        const b = Math.floor(Math.random()*(a-5))+1;
        return { q: `${a} - ${b}`, a: a-b };
    }
    else { // Simple Mult
        const facts = [2,3,5,10];
        const a = facts[Math.floor(Math.random()*facts.length)];
        const b = Math.floor(Math.random()*10)+1;
        return { q: `${a} x ${b}`, a: a*b };
    }
}

// --- GAME: WOMBAT RUNNER ---
const RUNNER = {
    lanes: 3,
    laneWidth: 0,
    init: function() {
        this.laneWidth = canvas.width / 3;
        state.player.w = 60;
        state.player.h = 60;
        state.player.y = canvas.height - 100;
        state.player.lane = 1;
        state.speed = 4; // Vertical speed of gates
        state.question = getMathQuestion();
        state.answers = []; // These will be gates
        spawnGates();
        document.getElementById('controlsHint').innerText = "Tap Left/Right to switch lanes";
    },
    update: function() {
        // Move gates down
        state.answers.forEach(g => g.y += state.speed);
        
        // Spawn new gates if needed
        if(state.answers.length > 0 && state.answers[0].y > canvas.height + 50) {
            state.answers = []; // Clear old
            state.question = getMathQuestion();
            spawnGates();
            state.speed += 0.2; // Get faster
        }

        // Collision
        const pLane = state.player.lane;
        state.answers.forEach(g => {
            if(!g.hit && g.y + 50 > state.player.y && g.y < state.player.y + state.player.h) {
                // We are crossing the gate line
                if(g.lane === pLane) {
                    g.hit = true;
                    if(g.isCorrect) {
                        state.score += 10;
                        playSound('correct');
                    } else {
                        state.lives--;
                        playSound('wrong');
                        checkGameOver();
                    }
                }
            }
        });
    },
    draw: function() {
        // Background
        ctx.fillStyle = "#4caf50"; // Grass
        ctx.fillRect(0,0,canvas.width, canvas.height);
        
        // Lanes
        ctx.strokeStyle = "rgba(255,255,255,0.3)";
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.moveTo(this.laneWidth, 0); ctx.lineTo(this.laneWidth, canvas.height);
        ctx.moveTo(this.laneWidth*2, 0); ctx.lineTo(this.laneWidth*2, canvas.height);
        ctx.stroke();

        // Draw Player (Wombat)
        const px = (state.player.lane * this.laneWidth) + (this.laneWidth/2);
        ctx.font = "50px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("üê®", px, state.player.y + 30);

        // Draw Question (On HUD mostly, but let's put it on top of screen)
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.fillRect(0, 60, canvas.width, 60);
        ctx.fillStyle = "#fff";
        ctx.font = "bold 40px Arial";
        ctx.fillText(state.question.q + " = ?", canvas.width/2, 90);

        // Draw Gates
        state.answers.forEach(g => {
            const gx = g.lane * this.laneWidth;
            
            // Gate visual
            ctx.fillStyle = g.hit ? (g.isCorrect ? "green" : "red") : "#3e2723";
            ctx.fillRect(gx + 10, g.y, this.laneWidth - 20, 20);
            
            // Text visual
            ctx.fillStyle = "#fff";
            ctx.fillRect(gx + 20, g.y - 40, this.laneWidth - 40, 40);
            ctx.fillStyle = "#000";
            ctx.font = "bold 24px Arial";
            ctx.fillText(g.val, gx + (this.laneWidth/2), g.y - 20);
        });
    },
    input: function(x) {
        if(x < canvas.width / 2) {
            if(state.player.lane > 0) state.player.lane--;
        } else {
            if(state.player.lane < 2) state.player.lane++;
        }
    }
};

function spawnGates() {
    const correctLane = Math.floor(Math.random()*3);
    for(let i=0; i<3; i++) {
        let val;
        if(i === correctLane) val = state.question.a;
        else val = state.question.a + (Math.floor(Math.random()*10)-5);
        if(val === state.question.a && i !== correctLane) val += 1; // Prevent duplicate correct

        state.answers.push({
            lane: i,
            y: -100, // Start above screen
            val: val,
            isCorrect: (i === correctLane),
            hit: false
        });
    }
}

// --- GAME: ASTRO BLASTER ---
const ASTRO = {
    init: function() {
        state.player.x = canvas.width / 2;
        state.player.y = canvas.height - 80;
        state.question = { q: "Multiples of 2", target: 2 }; // Start easy
        state.answers = [];
        state.speed = 2;
        document.getElementById('controlsHint').innerText = "Tap falling rocks matching the rule!";
        changeAstroRule();
    },
    update: function() {
        // Spawn rocks
        if(Math.random() < 0.02) spawnRock();
        
        // Move rocks
        for(let i = state.answers.length - 1; i >= 0; i--) {
            let r = state.answers[i];
            r.y += r.speed;
            
            // If hits bottom
            if(r.y > canvas.height) {
                state.answers.splice(i, 1);
                // If we missed a correct one, lose life? Maybe too hard.
                // Let's just ignore misses for now, focus on correct hits.
            }
        }
    },
    draw: function() {
        // Space BG
        ctx.fillStyle = "#1a237e";
        ctx.fillRect(0,0,canvas.width, canvas.height);
        
        // Draw Ship
        ctx.font = "60px Arial";
        ctx.textAlign = "center";
        ctx.fillText("üöÄ", canvas.width/2, canvas.height - 40);

        // Draw Rule
        ctx.fillStyle = "rgba(255,255,255,0.2)";
        ctx.fillRect(0, canvas.height - 140, canvas.width, 40);
        ctx.fillStyle = "#ffeb3b";
        ctx.font = "bold 24px Arial";
        ctx.fillText("SHOOT: " + state.question.q, canvas.width/2, canvas.height - 110);

        // Draw Rocks
        state.answers.forEach(r => {
            ctx.fillStyle = "#795548";
            ctx.beginPath();
            ctx.arc(r.x, r.y, 30, 0, Math.PI*2);
            ctx.fill();
            
            ctx.fillStyle = "#fff";
            ctx.font = "bold 20px Arial";
            ctx.textBaseline = "middle";
            ctx.fillText(r.val, r.x, r.y);
        });
    },
    input: function(x, y) {
        // Check tap on rock
        for(let i = state.answers.length - 1; i >= 0; i--) {
            let r = state.answers[i];
            const dist = Math.hypot(r.x - x, r.y - y);
            if(dist < 50) { // Hit
                // Check logic
                let isCorrect = false;
                if(state.question.type === 'mult') {
                    if(r.val % state.question.target === 0) isCorrect = true;
                } else if (state.question.type === 'odd') {
                    if(r.val % 2 !== 0) isCorrect = true;
                }
                
                if(isCorrect) {
                    state.score += 5;
                    playSound('correct');
                    // Sparkle effect could go here
                } else {
                    state.lives--;
                    playSound('wrong');
                    checkGameOver();
                }
                state.answers.splice(i, 1);
                
                if(state.score > 0 && state.score % 20 === 0) changeAstroRule();
                return;
            }
        }
    }
};

function changeAstroRule() {
    const rules = [
        { q: "Even Numbers", type: "mult", target: 2 },
        { q: "Multiples of 5", type: "mult", target: 5 },
        { q: "Multiples of 10", type: "mult", target: 10 },
        { q: "Multiples of 3", type: "mult", target: 3 }
    ];
    state.question = rules[Math.floor(Math.random()*rules.length)];
}

function spawnRock() {
    // Generate number based on rule (sometimes correct, sometimes not)
    let val;
    const isTarget = Math.random() > 0.6; // 40% chance of being a target
    
    if(isTarget) {
        val = (Math.floor(Math.random()*10)+1) * state.question.target;
    } else {
        val = Math.floor(Math.random()*50)+1;
        // Ensure it's not accidentally correct
        if(val % state.question.target === 0) val++; 
    }

    state.answers.push({
        x: Math.random() * (canvas.width - 60) + 30,
        y: -50,
        val: val,
        speed: Math.random() * 2 + 1
    });
}

// --- GLOBAL ENGINE LOOPS ---
function startGame(mode) {
    gameMode = mode;
    state.score = 0;
    state.lives = 3;
    state.isPlaying = true;
    
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('gameover').classList.add('hidden');
    document.getElementById('hud').classList.remove('hidden');
    
    if(mode === 'runner') RUNNER.init();
    if(mode === 'astro') ASTRO.init();
    
    if(animationId) cancelAnimationFrame(animationId);
    loop();
}

function loop() {
    if(!state.isPlaying) return;
    
    ctx.clearRect(0,0,canvas.width, canvas.height);
    
    if(gameMode === 'runner') {
        RUNNER.update();
        RUNNER.draw();
    } else if (gameMode === 'astro') {
        ASTRO.update();
        ASTRO.draw();
    }
    
    updateHUD();
    animationId = requestAnimationFrame(loop);
}

function updateHUD() {
    document.getElementById('scoreDisplay').innerText = state.score;
    document.getElementById('livesDisplay').innerText = "‚ù§Ô∏è".repeat(state.lives);
}

function checkGameOver() {
    if(state.lives <= 0) {
        state.isPlaying = false;
        document.getElementById('gameover').classList.remove('hidden');
        document.getElementById('finalScore').innerText = state.score;
        
        // High Score
        const saved = localStorage.getItem('mathHeroScore') || 0;
        if(state.score > saved) {
            localStorage.setItem('mathHeroScore', state.score);
            document.getElementById('highScoreMsg').innerText = "NEW HIGH SCORE! üèÜ";
        } else {
            document.getElementById('highScoreMsg').innerText = `Best: ${saved}`;
        }
    }
}

function restartGame() {
    startGame(gameMode);
}

// --- INPUT HANDLING ---
canvas.addEventListener('mousedown', handleInput);
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault(); // Prevent scrolling
    handleInput(e.touches[0]);
}, {passive: false});

function handleInput(e) {
    if(!state.isPlaying) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    if(gameMode === 'runner') RUNNER.input(x);
    if(gameMode === 'astro') ASTRO.input(x, y);
}

</script>
</body>
</html>
