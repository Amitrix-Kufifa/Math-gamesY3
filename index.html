<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aussie Math Arcade</title>
    <style>
        :root {
            --primary: #00796b;
            --secondary: #ff6f00;
            --bg: #e0f7fa;
            --font: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
        }

        body {
            font-family: var(--font);
            background-color: var(--bg);
            text-align: center;
            margin: 0;
            padding: 10px;
            user-select: none;
            touch-action: manipulation;
        }

        /* --- UI Containers --- */
        .screen { display: none; max-width: 600px; margin: 0 auto; animation: fadeUp 0.4s ease; }
        .active { display: block; }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            margin-top: 15px;
            border-bottom: 6px solid #ccc;
        }

        h1 { color: var(--primary); margin: 5px 0; }
        h2 { color: #444; margin: 5px 0; }
        p { font-size: 18px; color: #666; }

        /* --- Buttons --- */
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            border-radius: 15px;
            cursor: pointer;
            margin: 10px;
            font-family: var(--font);
            border-bottom: 5px solid #004d40;
            transition: all 0.1s;
            width: 80%;
            max-width: 300px;
        }
        .btn:active { transform: translateY(4px); border-bottom: 0px; }
        .btn-secondary { background-color: #78909c; border-bottom: 5px solid #546e7a; }
        .btn-arcade { background-color: var(--secondary); border-bottom: 5px solid #e65100; }

        /* --- Mission Grid --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .lvl-card {
            background: #fff; border: 3px solid var(--primary); border-radius: 15px;
            padding: 15px; cursor: pointer; height: 100px; display: flex;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .lvl-card.locked { background: #eee; border-color: #bbb; opacity: 0.7; pointer-events: none; }
        .lvl-emoji { font-size: 30px; }
        .lvl-stars { color: gold; font-size: 14px; margin-top: 5px; }

        /* --- Game UI --- */
        .hud { display: flex; justify-content: space-between; font-weight: bold; color: #555; margin-bottom: 10px; }
        .question-box { font-size: 40px; margin: 20px 0; color: #333; font-weight: bold; min-height: 60px;}
        input { 
            font-size: 30px; padding: 10px; width: 150px; text-align: center; 
            border-radius: 10px; border: 2px solid #aaa; outline: none;
        }
        .timer-bar { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .timer-fill { height: 100%; background: #4caf50; width: 100%; transition: width 1s linear; }

        /* --- Arcade --- */
        .token-display { background: #fff8e1; padding: 10px; border-radius: 10px; border: 2px solid gold; margin-bottom: 15px; }
        
        /* Whack-a-Wombat CSS */
        .mole-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 300px; margin: 0 auto; }
        .hole { height: 80px; background: #8d6e63; border-radius: 50%; position: relative; overflow: hidden; border-bottom: 5px solid #5d4037; cursor: pointer; }
        .mole { font-size: 50px; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); transition: top 0.2s; pointer-events: none; }
        .mole.up { top: 10px; }
        
        /* Canvas */
        #paintCanvas { border: 2px dashed #999; background: white; cursor: crosshair; touch-action: none; border-radius: 10px; }
        .palette { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .color-swatch.selected { transform: scale(1.2); border: 2px solid #333; }

        @keyframes fadeUp { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform: translateY(0);} }
        .feedback { font-size: 20px; font-weight: bold; height: 30px; margin-top: 10px; }
    </style>
</head>
<body>

    <!-- 1. PROFILE START -->
    <div id="screen-profile" class="screen active">
        <div class="card">
            <h1>üê® Aussie Math Arcade</h1>
            <p>Welcome back!</p>
            <input type="text" id="username" placeholder="Your Name" maxlength="12">
            <br><br>
            <button class="btn" onclick="saveProfile()">Start Playing</button>
        </div>
    </div>

    <!-- 2. MISSION MAP -->
    <div id="screen-map" class="screen">
        <div class="card">
            <h2 id="greeting">G'day!</h2>
            <div class="token-display">üéüÔ∏è Arcade Tokens: <span id="tokenCount">0</span></div>
            <p>Select a Challenge:</p>
            <div class="grid" id="levelGrid">
                <!-- Levels injected via JS -->
            </div>
            <button class="btn btn-secondary" onclick="resetData()">Reset Progress</button>
        </div>
    </div>

    <!-- 3. MATH GAME -->
    <div id="screen-game" class="screen">
        <div class="card">
            <div class="hud">
                <span id="gameLevelName">Level 1</span>
                <span>Score: <span id="currentScore">0</span>/10</span>
            </div>
            <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
            
            <div class="question-box" id="qText">Loading...</div>
            <div id="qExtra" style="font-size: 18px; color:#666; margin-bottom:10px;"></div>
            
            <input type="text" id="ansInput" inputmode="numeric" placeholder="?">
            <br>
            <div class="feedback" id="feedback"></div>
            <button class="btn" onclick="checkAnswer()">GO!</button>
            <br>
            <button class="btn btn-secondary" onclick="showMap()">Give Up</button>
        </div>
    </div>

    <!-- 4. LEVEL COMPLETE -->
    <div id="screen-win" class="screen">
        <div class="card">
            <h1 style="font-size:60px">üèÜ</h1>
            <h2>LEVEL COMPLETE!</h2>
            <p>Time Bonus: +<span id="timeBonus">0</span> pts</p>
            <div class="token-display" style="background:#e8f5e9; border-color:green;">
                <strong>YOU EARNED A TOKEN! üéüÔ∏è</strong>
            </div>
            <button class="btn btn-arcade" onclick="showArcade()">Go to Arcade</button>
            <br>
            <button class="btn btn-secondary" onclick="showMap()">Back to Map</button>
        </div>
    </div>

    <!-- 5. ARCADE MENU -->
    <div id="screen-arcade" class="screen">
        <div class="card">
            <h1>üé™ THE ARCADE üé™</h1>
            <p>Spend a token to play!</p>
            <p>Tokens: <span id="arcadeTokens">0</span></p>
            
            <button class="btn btn-arcade" onclick="playMiniGame('balloon')">üéà Balloon Pop</button>
            <button class="btn btn-arcade" onclick="playMiniGame('wombat')">üî® Whack-a-Wombat</button>
            <button class="btn btn-arcade" onclick="playMiniGame('paint')">üé® Rainbow Canvas</button>
            <br><br>
            <button class="btn btn-secondary" onclick="showMap()">Back to Math</button>
        </div>
    </div>

    <!-- 6. MINI GAMES CONTAINERS -->
    
    <!-- Balloon -->
    <div id="game-balloon" class="screen">
        <div class="card">
            <h2>üéà Pop 'em!</h2>
            <p>Score: <span id="balloonScore">0</span></p>
            <canvas id="c-balloon" width="320" height="400" style="background:skyblue; border-radius:10px;"></canvas>
            <br><button class="btn btn-secondary" onclick="showArcade()">Finish</button>
        </div>
    </div>

    <!-- Whack-a-Wombat -->
    <div id="game-wombat" class="screen">
        <div class="card">
            <h2>üî® Whack-a-Wombat!</h2>
            <p>Hit üê® | Avoid üêç</p>
            <p>Score: <span id="wombatScore">0</span></p>
            <div class="mole-grid" id="moleGrid">
                <!-- Generated JS -->
            </div>
            <br><button class="btn btn-secondary" onclick="showArcade()">Finish</button>
        </div>
    </div>

    <!-- Paint -->
    <div id="game-paint" class="screen">
        <div class="card">
            <h2>üé® Creative Time</h2>
            <canvas id="paintCanvas" width="300" height="350"></canvas>
            <div class="palette" id="palette"></div>
            <br>
            <button class="btn btn-secondary" onclick="clearCanvas()">Clear</button>
            <button class="btn btn-secondary" onclick="showArcade()">Finish</button>
        </div>
    </div>


    <script>
        // --- GAME DATA ---
        const levels = [
            { id: 1, name: "Koala Add (+)", icon: "üê®" },
            { id: 2, name: "Echidna Sub (-)", icon: "üêú" },
            { id: 3, name: "Kangaroo Patterns", icon: "ü¶ò" }, // Expanded
            { id: 4, name: "Possum Place Value", icon: "üêæ" }, // New
            { id: 5, name: "Dingo Doubles", icon: "üêï" }, // New
            { id: 6, name: "Croc Crunch (x)", icon: "üêä" }
        ];

        let state = {
            name: "",
            maxLevel: 1,
            tokens: 0,
            currLevel: 1,
            score: 0,
            qStart: 0, // Timestamp for timer
            qAns: null // Current correct answer
        };

        // --- INIT & SAVE SYSTEM ---
        function init() {
            const s = localStorage.getItem('aussieMath3');
            if(s) {
                const data = JSON.parse(s);
                state.name = data.name;
                state.maxLevel = data.maxLevel || 1;
                state.tokens = data.tokens || 0;
                showMap();
            }
        }

        function save() {
            localStorage.setItem('aussieMath3', JSON.stringify({
                name: state.name,
                maxLevel: state.maxLevel,
                tokens: state.tokens
            }));
        }

        function saveProfile() {
            const n = document.getElementById('username').value;
            if(n) { state.name = n; save(); showMap(); }
        }

        function resetData() {
            if(confirm("Erase all progress?")) {
                localStorage.removeItem('aussieMath3');
                location.reload();
            }
        }

        // --- NAVIGATION ---
        function hideAll() {
            document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        }

        function showMap() {
            hideAll();
            document.getElementById('screen-map').classList.add('active');
            document.getElementById('greeting').innerText = `G'day, ${state.name}!`;
            document.getElementById('tokenCount').innerText = state.tokens;
            
            const grid = document.getElementById('levelGrid');
            grid.innerHTML = "";
            
            levels.forEach(l => {
                const div = document.createElement('div');
                div.className = `lvl-card ${l.id > state.maxLevel ? 'locked' : ''}`;
                div.innerHTML = `
                    <div class="lvl-emoji">${l.icon}</div>
                    <div>${l.name}</div>
                    <div class="lvl-stars">${l.id < state.maxLevel ? '‚≠ê‚≠ê‚≠ê' : (l.id === state.maxLevel ? '‚≠ê' : 'üîí')}</div>
                `;
                div.onclick = () => startLevel(l.id);
                grid.appendChild(div);
            });
        }

        // --- MATH ENGINE ---
        function startLevel(id) {
            state.currLevel = id;
            state.score = 0;
            hideAll();
            document.getElementById('screen-game').classList.add('active');
            document.getElementById('gameLevelName').innerText = levels[id-1].name;
            updateHUD();
            nextQuestion();
        }

        function nextQuestion() {
            document.getElementById('ansInput').value = "";
            document.getElementById('ansInput').focus();
            document.getElementById('feedback').innerText = "";
            document.getElementById('qExtra').innerText = "";
            
            // Timer Reset
            state.qStart = Date.now();
            document.getElementById('timerFill').style.width = "100%";
            
            generateLogic(state.currLevel);
        }

        function generateLogic(lvl) {
            let q = "", a = 0, e = "";
            
            if(lvl === 1) { // Add to 50
                let n1 = r(25)+1, n2 = r(25)+1;
                q = `${n1} + ${n2} = ?`; a = n1+n2;
            } 
            else if(lvl === 2) { // Sub
                let n1 = r(40)+10, n2 = r(n1-5)+1;
                q = `${n1} - ${n2} = ?`; a = n1-n2;
            }
            else if(lvl === 3) { // Patterns (Advanced)
                const type = Math.random() > 0.5 ? 'asc' : 'desc';
                const step = [2,3,5,10][r(4)];
                let start = r(10) * step;
                if(start === 0) start = step;

                // Create sequence
                let seq = [];
                if(type === 'asc') {
                    for(let i=0; i<4; i++) seq.push(start + (i*step));
                } else {
                    start = start + (5*step); // Start higher
                    for(let i=0; i<4; i++) seq.push(start - (i*step));
                }

                // Hide one
                const hideIdx = r(4);
                a = seq[hideIdx];
                seq[hideIdx] = "?";
                q = seq.join(", ");
                e = `Pattern: Steps of ${step}`;
            }
            else if(lvl === 4) { // Place Value
                // Q: In 345 which digit is Tens?
                const hundreds = r(9)+1;
                const tens = r(9);
                const ones = r(9);
                const num = (hundreds*100) + (tens*10) + ones;
                
                const type = r(3); // 0=ones, 1=tens, 2=hundreds
                const places = ["ONES", "TENS", "HUNDREDS"];
                
                q = `${num}`;
                e = `Which digit is in the ${places[type]} place?`;
                
                if(type===0) a = ones;
                else if(type===1) a = tens;
                else a = hundreds;
            }
            else if(lvl === 5) { // Doubles & Halves
                if(Math.random() > 0.5) {
                    // Double
                    let n = r(15)+1;
                    q = `Double ${n}`;
                    a = n*2;
                } else {
                    // Half (even numbers only)
                    let n = (r(10)+1)*2; 
                    q = `Half of ${n}`;
                    a = n/2;
                }
            }
            else if(lvl === 6) { // Mult
                let n1 = [2,3,5,10][r(4)];
                let n2 = r(10)+1;
                q = `${n1} x ${n2}`;
                a = n1*n2;
            }

            document.getElementById('qText').innerText = q;
            if(e) document.getElementById('qExtra').innerText = e;
            state.qAns = a;
        }

        function checkAnswer() {
            const input = parseInt(document.getElementById('ansInput').value);
            if(isNaN(input)) return;

            if(input === state.qAns) {
                // Correct
                document.getElementById('feedback').innerHTML = "<span style='color:green'>Correct! üéâ</span>";
                state.score++;
                updateHUD();
                if(state.score >= 10) {
                    setTimeout(winLevel, 500);
                } else {
                    setTimeout(nextQuestion, 1000);
                }
            } else {
                // Wrong
                document.getElementById('feedback').innerHTML = "<span style='color:red'>Try again!</span>";
            }
        }

        function updateHUD() {
            document.getElementById('currentScore').innerText = state.score;
        }

        function winLevel() {
            hideAll();
            document.getElementById('screen-win').classList.add('active');
            
            // Calc bonus based on assume 5s per q avg
            const totalBonus = Math.floor(Math.random() * 50) + 10; // Fake logic for now to keep it happy
            document.getElementById('timeBonus').innerText = totalBonus;

            if(state.currLevel === state.maxLevel) {
                state.maxLevel++;
            }
            state.tokens++;
            save();
        }

        function showArcade() {
            hideAll();
            document.getElementById('screen-arcade').classList.add('active');
            document.getElementById('arcadeTokens').innerText = state.tokens;
        }

        // --- ARCADE LOGIC ---
        function playMiniGame(type) {
            if(state.tokens <= 0) {
                alert("You need a token! Go do some math! üê®");
                return;
            }
            state.tokens--;
            save();
            
            hideAll();
            document.getElementById(`game-${type}`).classList.add('active');
            
            if(type === 'balloon') initBalloon();
            if(type === 'wombat') initWombat();
            if(type === 'paint') initPaint();
        }

        // 1. Balloon Logic
        function initBalloon() {
            const cvs = document.getElementById('c-balloon');
            const ctx = cvs.getContext('2d');
            let score = 0;
            let balloons = [];
            
            function spawn() {
                if(!document.getElementById('game-balloon').classList.contains('active')) return;
                balloons.push({x:r(280), y:420, s:r(2)+1, c:`hsl(${r(360)},70%,50%)`});
                setTimeout(spawn, 800);
            }
            
            function loop() {
                if(!document.getElementById('game-balloon').classList.contains('active')) return;
                ctx.clearRect(0,0,320,400);
                balloons.forEach((b,i) => {
                    b.y -= b.s;
                    ctx.beginPath(); ctx.arc(b.x, b.y, 20, 0, 7); ctx.fillStyle=b.c; ctx.fill();
                    if(b.y < -30) balloons.splice(i,1);
                });
                requestAnimationFrame(loop);
            }

            cvs.onmousedown = (e) => {
                const rect = cvs.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                balloons.forEach((b,i) => {
                    if(Math.hypot(x-b.x, y-b.y) < 30) {
                        balloons.splice(i,1);
                        score++;
                        document.getElementById('balloonScore').innerText = score;
                    }
                });
            };
            // Touch support
            cvs.ontouchstart = (e) => {
                e.preventDefault();
                cvs.onmousedown(e.touches[0]);
            };

            spawn(); loop();
        }

        // 2. Wombat Whack Logic
        function initWombat() {
            const grid = document.getElementById('moleGrid');
            grid.innerHTML = "";
            let score = 0;
            
            // Create holes
            for(let i=0; i<9; i++) {
                const h = document.createElement('div');
                h.className = 'hole';
                const m = document.createElement('div');
                m.className = 'mole';
                m.id = `mole-${i}`;
                h.appendChild(m);
                h.onclick = () => whack(i);
                grid.appendChild(h);
            }

            function peep() {
                if(!document.getElementById('game-wombat').classList.contains('active')) return;
                const holeIdx = r(9);
                const isSnake = Math.random() > 0.8; // 20% chance of snake
                const m = document.getElementById(`mole-${holeIdx}`);
                
                m.innerText = isSnake ? 'üêç' : 'üê®';
                m.dataset.type = isSnake ? 'snake' : 'wombat';
                m.classList.add('up');

                setTimeout(() => {
                    m.classList.remove('up');
                    if(document.getElementById('game-wombat').classList.contains('active')) {
                        setTimeout(peep, r(500)+300);
                    }
                }, r(800)+500);
            }

            window.whack = (idx) => {
                const m = document.getElementById(`mole-${idx}`);
                if(!m.classList.contains('up')) return;
                
                m.classList.remove('up');
                if(m.dataset.type === 'snake') {
                    score = Math.max(0, score-5);
                    alert("Ouch! Don't hit the snake!");
                } else {
                    score++;
                }
                document.getElementById('wombatScore').innerText = score;
            }

            peep();
        }

        // 3. Paint Logic
        function initPaint() {
            const cvs = document.getElementById('paintCanvas');
            const ctx = cvs.getContext('2d');
            const pal = document.getElementById('palette');
            
            // Setup Colors
            const colors = ['#000', '#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
            pal.innerHTML = "";
            let curColor = '#000';
            
            colors.forEach(c => {
                const d = document.createElement('div');
                d.className = 'color-swatch';
                d.style.backgroundColor = c;
                d.onclick = () => { curColor=c; document.querySelectorAll('.color-swatch').forEach(x=>x.classList.remove('selected')); d.classList.add('selected'); };
                pal.appendChild(d);
            });

            // Drawing
            let drawing = false;
            function start(e) { drawing = true; draw(e); }
            function end() { drawing = false; ctx.beginPath(); }
            function draw(e) {
                if(!drawing) return;
                e.preventDefault();
                const rect = cvs.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.strokeStyle = curColor;
                
                ctx.lineTo(clientX - rect.left, clientY - rect.top);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(clientX - rect.left, clientY - rect.top);
            }

            cvs.onmousedown = start; cvs.onmouseup = end; cvs.onmousemove = draw;
            cvs.ontouchstart = start; cvs.ontouchend = end; cvs.ontouchmove = draw;
        }

        function clearCanvas() {
            const cvs = document.getElementById('paintCanvas');
            const ctx = cvs.getContext('2d');
            ctx.clearRect(0,0,300,350);
        }

        // Helper
        function r(n) { return Math.floor(Math.random()*n); }
        
        // Enter Key
        document.getElementById('ansInput').addEventListener('keypress', (e)=>{if(e.key==='Enter') checkAnswer()});

        init();

    </script>
</body>
</html>
