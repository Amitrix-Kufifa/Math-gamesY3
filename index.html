<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aussie Math Adventures</title>
    <style>
        :root {
            --primary: #00897b;
            --accent: #ffca28;
            --bg: #e0f2f1;
            --font: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
        }

        body {
            font-family: var(--font);
            background-color: var(--bg);
            text-align: center;
            margin: 0;
            padding: 10px;
            user-select: none;
        }

        /* --- Layout Containers --- */
        .screen { display: none; max-width: 600px; margin: 0 auto; }
        .active { display: block; animation: fadeIn 0.5s; }

        .card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            margin-top: 20px;
        }

        h1 { color: #004d40; margin-bottom: 5px; }
        h2 { color: #00796b; }
        p { font-size: 18px; color: #555; }

        /* --- Inputs & Buttons --- */
        input {
            font-size: 24px; padding: 10px; border-radius: 10px;
            border: 2px solid #aaa; width: 80%; text-align: center;
            font-family: var(--font); margin-bottom: 10px;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 20px;
            border-radius: 12px;
            cursor: pointer;
            margin: 10px 5px;
            font-family: var(--font);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        button.secondary { background-color: #78909c; }
        button:disabled { background-color: #cfd8dc; cursor: not-allowed; opacity: 0.7; }

        /* --- Level Select Grid --- */
        .mission-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .mission-btn {
            height: 120px;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 4px solid var(--primary);
            color: #333;
        }
        .mission-btn.locked {
            background: #eee; border-color: #ccc; color: #999;
        }
        .stars { color: gold; font-size: 24px; margin-top: 5px; }

        /* --- Game Area --- */
        .progress-bar {
            width: 100%; height: 20px; background: #ddd;
            border-radius: 10px; overflow: hidden; margin-bottom: 20px;
        }
        .progress-fill {
            height: 100%; background: #76ff03; width: 0%; transition: width 0.3s;
        }
        .question { font-size: 50px; margin: 30px 0; font-weight: bold; color: #333; }
        .feedback { height: 30px; font-size: 20px; font-weight: bold; }
        .correct-text { color: green; }
        .wrong-text { color: red; }

        /* --- Rewards --- */
        .medal { font-size: 100px; animation: popIn 0.6s; }
        
        /* --- Balloon Pop Game --- */
        #balloon-canvas {
            background: skyblue;
            border-radius: 15px;
            cursor: crosshair;
            touch-action: none;
        }

        /* Animations */
        @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
        @keyframes popIn { 0% {transform: scale(0);} 80% {transform: scale(1.2);} 100% {transform: scale(1);} }

    </style>
</head>
<body>

    <!-- 1. PROFILE SCREEN -->
    <div id="screen-profile" class="screen active">
        <div class="card">
            <h1>üéì Math Adventures</h1>
            <p>Welcome! What is your name?</p>
            <input type="text" id="username" placeholder="Enter name..." maxlength="15">
            <br>
            <button onclick="saveProfile()">Let's Play!</button>
        </div>
    </div>

    <!-- 2. MISSION SELECT -->
    <div id="screen-missions" class="screen">
        <div class="card">
            <h2 id="greeting">Hi there!</h2>
            <p>Choose your mission:</p>
            <div class="mission-grid">
                <button class="mission-btn" onclick="startLevel(1)" id="lvl1">
                    üê® Koala Climb<br><small>(Addition)</small>
                    <div class="stars" id="star1"></div>
                </button>
                <button class="mission-btn locked" onclick="startLevel(2)" id="lvl2" disabled>
                    üêú Echidna Eats<br><small>(Subtraction)</small>
                    <div class="stars" id="star2">üîí</div>
                </button>
                <button class="mission-btn locked" onclick="startLevel(3)" id="lvl3" disabled>
                    ü¶ò Kangaroo Hop<br><small>(Patterns)</small>
                    <div class="stars" id="star3">üîí</div>
                </button>
                <button class="mission-btn locked" onclick="startLevel(4)" id="lvl4" disabled>
                    üêä Croc Crunch<br><small>(Multiplication)</small>
                    <div class="stars" id="star4">üîí</div>
                </button>
            </div>
            <br>
            <button class="secondary" onclick="resetProgress()">Reset Profile</button>
        </div>
    </div>

    <!-- 3. GAME SCREEN -->
    <div id="screen-game" class="screen">
        <div class="card">
            <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>
            <h2 id="levelTitle">Level 1</h2>
            <div class="question" id="questionText">2 + 2</div>
            <div class="feedback" id="feedbackText"></div>
            
            <input type="number" id="answerInput" inputmode="numeric" placeholder="?">
            <br>
            <button onclick="checkAnswer()">Submit</button>
            <br><br>
            <button class="secondary" onclick="showMissions()">Back to Map</button>
        </div>
    </div>

    <!-- 4. REWARD SCREEN -->
    <div id="screen-reward" class="screen">
        <div class="card">
            <div class="medal">ü•á</div>
            <h1>MISSION COMPLETE!</h1>
            <p>You are a math superstar!</p>
            <button onclick="playBonusGame()">üéà Play Balloon Pop!</button>
            <br>
            <button class="secondary" onclick="showMissions()">Back to Map</button>
        </div>
    </div>

    <!-- 5. BONUS GAME -->
    <div id="screen-bonus" class="screen">
        <div class="card">
            <h2>Pop the Balloons!</h2>
            <p>Score: <span id="bonusScore">0</span></p>
            <canvas id="balloon-canvas" width="300" height="400"></canvas>
            <br>
            <button class="secondary" onclick="showMissions()">Finish</button>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let state = {
            name: "",
            level: 1, // Current highest unlocked level
            currentScore: 0,
            targetScore: 10,
            currentLevelId: 1,
            num1: 0, num2: 0, ans: 0
        };

        // Load from LocalStorage
        function init() {
            const saved = localStorage.getItem('mathGameData');
            if (saved) {
                const data = JSON.parse(saved);
                state.name = data.name;
                state.level = data.level;
                showMissions();
            }
        }

        function saveProfile() {
            const name = document.getElementById('username').value;
            if (!name) return;
            state.name = name;
            state.level = 1;
            saveData();
            showMissions();
        }

        function saveData() {
            localStorage.setItem('mathGameData', JSON.stringify({
                name: state.name,
                level: state.level
            }));
        }

        function resetProgress() {
            if(confirm("Are you sure you want to erase progress?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- NAVIGATION ---
        function hideAll() {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        }

        function showMissions() {
            hideAll();
            document.getElementById('screen-missions').classList.add('active');
            document.getElementById('greeting').innerText = `G'day, ${state.name}!`;
            updateLevelButtons();
        }

        function updateLevelButtons() {
            for(let i=1; i<=4; i++) {
                const btn = document.getElementById(`lvl${i}`);
                const star = document.getElementById(`star${i}`);
                
                if (i <= state.level) {
                    btn.classList.remove('locked');
                    btn.disabled = false;
                    if (i < state.level) star.innerText = "‚≠ê‚≠ê‚≠ê"; // Completed
                    else star.innerText = "‚≠ê"; // Current
                } else {
                    btn.classList.add('locked');
                    btn.disabled = true;
                    star.innerText = "üîí";
                }
            }
        }

        // --- MATH LOGIC ---
        function startLevel(lvl) {
            state.currentLevelId = lvl;
            state.currentScore = 0;
            hideAll();
            document.getElementById('screen-game').classList.add('active');
            
            const titles = ["Koala Climb (+)", "Echidna Eats (-)", "Kangaroo Hop (Patterns)", "Croc Crunch (x)"];
            document.getElementById('levelTitle').innerText = titles[lvl-1];
            updateProgress();
            generateQuestion();
        }

        function generateQuestion() {
            document.getElementById('answerInput').value = "";
            document.getElementById('answerInput').focus();
            document.getElementById('feedbackText').innerText = "";

            const lvl = state.currentLevelId;

            if (lvl === 1) { // Addition to 50
                state.num1 = Math.floor(Math.random() * 25) + 1;
                state.num2 = Math.floor(Math.random() * 25) + 1;
                state.ans = state.num1 + state.num2;
                document.getElementById('questionText').innerText = `${state.num1} + ${state.num2} = ?`;
            } 
            else if (lvl === 2) { // Subtraction
                state.num1 = Math.floor(Math.random() * 40) + 10;
                state.num2 = Math.floor(Math.random() * (state.num1 - 5)) + 1;
                state.ans = state.num1 - state.num2;
                document.getElementById('questionText').innerText = `${state.num1} - ${state.num2} = ?`;
            }
            else if (lvl === 3) { // Patterns (Skip Counting)
                const steps = [2, 5, 10];
                const step = steps[Math.floor(Math.random() * steps.length)];
                const start = Math.floor(Math.random() * 5) * step;
                // Example: 2, 4, 6, ?
                state.ans = start + (step * 3);
                document.getElementById('questionText').innerText = `${start}, ${start+step}, ${start+(step*2)}, ?`;
            }
            else if (lvl === 4) { // Multiplication
                const facts = [2, 3, 5, 10];
                state.num1 = facts[Math.floor(Math.random() * facts.length)];
                state.num2 = Math.floor(Math.random() * 10) + 1;
                state.ans = state.num1 * state.num2;
                document.getElementById('questionText').innerText = `${state.num1} x ${state.num2} = ?`;
            }
        }

        function checkAnswer() {
            const userAns = parseInt(document.getElementById('answerInput').value);
            const feedback = document.getElementById('feedbackText');

            if (userAns === state.ans) {
                feedback.innerText = "Correct! Nice work!";
                feedback.className = "feedback correct-text";
                state.currentScore++;
                updateProgress();
                
                if (state.currentScore >= state.targetScore) {
                    levelComplete();
                } else {
                    setTimeout(generateQuestion, 1000);
                }
            } else {
                feedback.innerText = "Try again!";
                feedback.className = "feedback wrong-text";
            }
        }

        function updateProgress() {
            const pct = (state.currentScore / state.targetScore) * 100;
            document.getElementById('progFill').style.width = pct + "%";
        }

        function levelComplete() {
            // Unlock next level if at current max
            if (state.currentLevelId === state.level) {
                state.level++;
                saveData();
            }
            hideAll();
            document.getElementById('screen-reward').classList.add('active');
        }

        // --- BONUS GAME (BALLOONS) ---
        let canvas, ctx, balloons = [], animationId;
        
        function playBonusGame() {
            hideAll();
            document.getElementById('screen-bonus').classList.add('active');
            canvas = document.getElementById('balloon-canvas');
            ctx = canvas.getContext('2d');
            balloons = [];
            document.getElementById('bonusScore').innerText = "0";
            
            // Handle Clicks
            canvas.addEventListener('mousedown', popBalloon);
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); // prevent double firing
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent("mousedown", {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }, {passive: false});

            gameLoop();
            spawnBalloons();
        }

        function spawnBalloons() {
            if(!document.getElementById('screen-bonus').classList.contains('active')) return;
            
            const colors = ['#ff5252', '#448aff', '#69f0ae', '#ffd740', '#e040fb'];
            const b = {
                x: Math.random() * (canvas.width - 30),
                y: canvas.height + 30,
                r: 20,
                speed: Math.random() * 2 + 1,
                color: colors[Math.floor(Math.random() * colors.length)]
            };
            balloons.push(b);
            setTimeout(spawnBalloons, 800);
        }

        function gameLoop() {
            if(!document.getElementById('screen-bonus').classList.contains('active')) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (let i = 0; i < balloons.length; i++) {
                let b = balloons[i];
                b.y -= b.speed;
                
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.r, 0, Math.PI * 2);
                ctx.fillStyle = b.color;
                ctx.fill();
                ctx.stroke();
                
                // Remove if off screen
                if (b.y < -30) {
                    balloons.splice(i, 1);
                    i--;
                }
            }
            requestAnimationFrame(gameLoop);
        }

        function popBalloon(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            for (let i = balloons.length - 1; i >= 0; i--) {
                let b = balloons[i];
                let dist = Math.sqrt((x - b.x) ** 2 + (y - b.y) ** 2);
                if (dist < b.r + 10) { // +10 specifically for forgiving touch area
                    balloons.splice(i, 1);
                    let score = parseInt(document.getElementById('bonusScore').innerText);
                    document.getElementById('bonusScore').innerText = score + 1;
                    break;
                }
            }
        }

        // Event Listener for Enter key in Math
        document.getElementById('answerInput').addEventListener("keypress", function(event) {
            if (event.key === "Enter") checkAnswer();
        });

        // Start app
        init();

    </script>
</body>
</html>
